import { Steps } from '@/components/docs/steps'
import { Alert } from '@/components/docs/alert'
import { Icon } from '@/components/docs/icons'

# Integrate LDAP HA authentication <Icon name="xpackTip"/>

## About LDAP HA
**LDAP High Availability (LDAP HA)** ensures the LDAP service remains operational during failures through specific configurations and technical measures. This improves the availability and reliability of directory services, ensuring that directory information within an organization is continuously accessible.

In JumpServer, the integration of LDAP HA typically ensures that if the primary LDAP server fails, the system can automatically switch to a backup LDAP HA server, ensuring the continuity of authentication services. This way, even if an LDAP server experiences issues, JumpServer can continue processing user authentication requests without causing downtime or service interruptions.

<Alert type="tip">
Configure LDAP before setting up LDAP HA. See [Integrate LDAP auth](/docs/system-settings/authentication/ldap)
</Alert>

## How to configure

<Steps>

<div>
In the upper-right corner of any page in JumpServer, click <Icon name="settings"/>.
<img src="/images/docs/admin-guides/system-settings/nav-settings.png" alt="image" width="350"/>
</div>

<div>
Navigate to **System settings > Authentication > LDAP HA**.
</div>

<div>
In the **LDAP HA** field, check the box to enable LDAP HA authentication.
</div>

<div>
In the **Server** field, enter the LDAP HA server URI, such as "ldap://example.com:389" and "ldaps://example.com:636". 

<Alert type="note">
To configure LDAP HA TLS certificates, you can upload the files "ldap_ha_ca.pem, ldap_ha_cert.pem, ldap_ha_cert.key" to the directory "/data/jumpserver/core/data/certs", then restart the service.
</Alert>
</div>

<div>
In the **Bind DN** field, enter a user DN with at least query permissions, which will be used to query and filter users, such as "cn=admin,dc=example,dc=com".
</div>

<div>
In the **Password** field, enter the password for the "Bind DN" user.
</div>

<div>
In the **Search OU** field, enter the search OU to specify where to start searching for users, use `|` to separate multiple values, such as "ou=users,dc=example,dc=com | ou=tech,dc=example,dc=com".
</div>

<div>
In the **Search filter** field, enter the filter expression to search for LDAP HA users. By default, the expression is "(cn=%(user)s)", where "%(user)s" is the placeholder syntax in Python. During filtering, it is replaced with `*`, resulting in "(cn=\*)", which searches for all users. You can also replace "cn" with the actual username field, such as "uid" or "sAMAccountName".

</div>

<div>
In the **User attribute** field, enter the user attribute mapping. The key represents the JumpServer user attribute name (available options: name, username, email, groups, phone, comment), while the value corresponds to the LDAP HA user attribute name.

```json copy=true filename="LDAP HA User Attribute Example"
{
  "name": "cn",
  "email": "mail",
  "username": "cn",
  "groups": "memberOf"
}
```
</div>

<div>
In the **Connect timeout (s)** field, enter the LDAP HA connection timeout in seconds.
</div>

<div>
In the **Search paged size (piece)** field, enter the page size for searching users.
</div>

<div>
In the **User DN cache timeout (s)** field, enter the cache duration for user DN in seconds to improve login authentication speed. Submit the form to clear the cache if the user DN is changed, otherwise, authentication will fail.
</div>

<div>
Click **Submit**.
</div>

</Steps>


## Test LDAP HA connection
<Steps>
<div>
In the upper-right corner of any page in JumpServer, click <Icon name="settings"/>.
<img src="/images/docs/admin-guides/system-settings/nav-settings.png" alt="image" width="350"/>
</div>

<div>
Navigate to **System settings > Authentication > LDAP HA**.
</div>

<div>
Scroll to the bottom of the page and click the **Test connection** button.
</div>
</Steps>

## Test LDAP HA user login
<Steps>
<div>
In the upper-right corner of any page in JumpServer, click <Icon name="settings"/>.
<img src="/images/docs/admin-guides/system-settings/nav-settings.png" alt="image" width="350"/>
</div>

<div>
Navigate to **System settings > Authentication > LDAP HA**.
</div>

<div>
Complete the LDAP HA configuration and click **Submit**, then test the connection successfully.
</div>

<div>
Scroll to the bottom of the page and click the **Test login** button.
</div>

<div>
In the popup, enter the LDAP HA username and password, then click **Confirm**.
<img src="/images/docs/admin-guides/system-settings/auth/ldap-test-user-login-popup.png" alt="image" width="650"/>
</div>
</Steps>

## Import LDAP HA users

<Steps>
<div>
In the upper-right corner of any page in JumpServer, click <Icon name="settings"/>.
<img src="/images/docs/admin-guides/system-settings/nav-settings.png" alt="image" width="350"/>
</div>

<div>
Navigate to **System settings > Authentication > LDAP HA**.
</div>

<div>
Complete the LDAP HA configuration and click **Submit**, then test the connection successfully.
</div>

<div>
Scroll to the bottom of the page and click the **User import** button.
</div>

<div>
In the popup, you can perform the following actions:

    * Click the **Sync users** button at the bottom of the table to sync LDAP HA users to the current table.
    * In the **Import organization** field at the bottom left of the table, select one or more organizations to import.
    * Select the users you want to import in the table, then click the **Import** button at the bottom to continue.
    * Click **Import all** at the bottom of the table to import all users.
    * Click **Cancel** at the bottom of the table to close the popup.

      <img src="/images/docs/admin-guides/system-settings/auth/ldap-import-user.png" alt="image" width="650"/>

</div>

</Steps>

##  Set up LDAP HA user sync
<Steps>
<div>
In the upper-right corner of any page in JumpServer, click <Icon name="settings"/>.
<img src="/images/docs/admin-guides/system-settings/nav-settings.png" alt="image" width="350"/>
</div>

<div>
Navigate to **System settings > Authentication > LDAP HA**.
</div>

<div>
Complete the LDAP HA configuration and click **Submit**, then test the connection successfully.
</div>

<div>
Scroll to the bottom of the page and click the **Sync settings** button.
</div>

<div>
In the popup, you can configure the following fields:

    * In the **Organization** field, Select one or more organizations, and the users will be synced to these organizations.
    * In the **Periodic** field, check the box to enable periodic sync.
    * In the **Crontab** field, enter the crontab expression. If empty, "Interval" field's value will be used.
    * In the **Interval** field, enter the sync interval in hour. If the "Crontab" field has a value, it will be prioritized.
    * In the **Recipients** fields, select one or more users to receive the sync result.
    * Click **Confirm** to save the settings.
      <img src="/images/docs/admin-guides/system-settings/auth/ldap-sync-settings.png" alt="image" width="550"/>

</div>
</Steps>